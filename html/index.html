<html>
<head>
<link rel="stylesheet" type="text/css" href="main.css" />
</head>
<body>

    <script src="jquery-1.6.2.js"></script>
    <a href="#" id="reladList">Reload server list</a>
    <script type="text/javascript">
        $(document).ready(function(){
           $('#reladList').click(loadDatabaseList);
         });
        
        function loadDatabaseList(event){
            $.get("/api/database/list", function(json) {
            	var table = $('#dbTable')
            	table.empty();
            	for(i in json) {
            		table.append(
            		'<div class="dbItem" host="'+json[i].host+'/'+json[i].sid+'"> \
            		<div class="dbInfo" >          \
            		<div class="name">'+ json[i].sid + ' @ ' +json[i].host + '</div>      \
            		</div>                                                                \
            		<div class="dbOperations">                                            \
                    <a href="#" class="dbRefresh">refresh</a>                            \
                    </div> \
                    <div class="dbLoading">Loading <img src="loading_icon.gif" /></div> \
                    </div> '
                    );
            	}
            	console.log(json);
            	table.children('.dbLoading').hide();
            	$('.dbRefresh').click(loadSchemesList);
                $('.dbRefresh').click();
            });     
        }
        
        function loadSchemesList(e) {
        	link = $(e.target);
        	//disable double click 
        	link.unbind('click');
        	link.attr('disabled', 'disabled');
        	
        	
        	item = link.parents('.dbItem');
        	item.children().remove(".schema");                
        	item.children('.dbLoading').show();
        	
            hostId = item.attr('host');
            var requestUrl = "/api/database/info/" + hostId;
            console.log('sent ' + requestUrl);
            $.get(requestUrl, function(json) {
            	hostId = requestUrl.substr("/api/database/info/".length);
            	item = $('.dbItem[host="'+hostId+'"]');            	
            	item.children().remove(".schema");     
            	item.children('.dbLoading').hide();
                for(i in json) {
                	item.append(''+
                	  '<div class="schema">' + 
                	  '<div class="name">'+json[i].name+'</div>' + 
                	  '<div class="size">'+json[i].size+'GB</div>' + 
                	  '</div>' 
                	);
                }
                link = item.find('.dbRefresh');
                link.click(loadSchemesList);
                link.removeAttr('disabled');
            });
        }
        
	</script>

    <h1>List of DB</h1>
    <div class="dbTable" id="dbTable">
        <div class="dbItem" host="mox04.sibirenergo-billing.ru/qaasr">
            <div class="dbInfo" >
                <div class="name">mox04.sibirenergo-billing.ru</div>
                <div class="sid">qaasr</div>
            </div>
            <div class="dbOperations">
                <a href="#" class="dbRefresh">refresh</a>
            </div>
            <div class="schema">
                <div class="name">DEMO_KEMEROVO</div>
                <div class="size">37GB</div>
            </div>
            <div class="schema">
                <div class="name">DEV_RENAT123</div>
                <div class="size">38GB</div>
            </div>
        </div>
        <div class="dbItem">
            <div class="dbInfo">
                <div class="name">mox04.sibirenergo-billing.ru</div>
                <div class="sid">qaasr</div>
            </div>
            <div class="dbLoading">
                Loading <img src="loading_icon.gif" />
            </div>
        </div>
    </div>

</body>
</html>