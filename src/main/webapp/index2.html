<html>
<head>
<link rel="stylesheet" type="text/css" href="main.css" />
<link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css">
<style type="text/css"> /* Override some defaults */
html,body {
	background-color: #eee;
}
body {
	padding-top: 10px;
}

#header {
	padding-bottom: 10px;	
}
#loadingDiv {
	text-align: center;
}

</style>
</head>
<body>

    <script src="jquery-1.6.2.js"></script>
    <script
        src="http://twitter.github.com/bootstrap/1.3.0/bootstrap-modal.js"></script>
    <script src="jquery.tmpl.js"></script>
    <script src="oculus.js"></script>
    <script id="tmplSidItem" type="text/x-jquery-tmpl">
        <option host="${host}" sid="${sid}">${presentation}</option>
    </script>
    <script id="tmplTablespace" type="text/x-jquery-tmpl">
                            <tr class="tablespace">
                            <td >${name}</td>
                            <td >${freeSpace}GB</td>
                            <td >${totalSpace}GB</td>
                            <td >${used}%</td>
                            </tr>
    </script>
    <script id="tmplSchema" type="text/x-jquery-tmpl">
                            <tr class="{{if connectionCount > 0 && connectionCount <= 3 }}schemaFree {{/if}}{{if connectionCount > 3 }}schemaUsed {{/if}}dbSchema">
                            <td >${name}</td>
                            <td >${size}GB</td>
                            <td >${connectionCount}</td>
                            <td class="right">{{if connectionCount < 1 }}<a class="btn danger schemaDrop">Drop</a>{{/if}}</td>
                            </tr>
    </script>
    <script id="tmplDump" type="text/x-jquery-tmpl">
                            <tr class="dump">
                            <td ><input class="dumpRadio" type="radio" name ="dumps" value="${name}"/></td>
                            <td >${name}</td>
                            </tr>
    </script>
    <script type="text/javascript">
        $(document).ready(function(){
        	
            menu = new Menu({
                menuSchemas:{div:"schemas", cb: refreshSchemas},
                menuTablespaces:{div:"tablespaces", cb: refreshTablespace },
                menuDumps:{div:"dumps", cb:refreshDumps}
                });
        	menu.init();
            
           $('#reloadSidList').click(function(){
           	   _ajaxCall("/api/sid", reloadSidListCB)
           });
           
           $("#confirmModalNo").click(function() {
        	   $("#confirmModal").modal('hide');
           });
         });
        
        function dumpInstall() {
        	var validationError = 0;
        	var schemaName = $('#schemaName').val();
        	if( schemaName == null || schemaName == '' ) {
        		$('#cDumpName').addClass('error');
        		validationError = 1;
        	} else {
        		$('#cDumpName').removeClass('error');
        	} 
        	var remapName = $('#remapName').val();
        	if( remapName == null || remapName == '' ) {
        		$('#cRemapName').addClass('error');
        		validationError = 1;
        	} else {
        		$('#cRemapName').removeClass('error');
        	} 
        	if( validationError == 0 ) {
        		var link = $("#dbList").children(".active").children("a");
        		var dump = $(".dumpRadio:checked").val();
                var requestUrl = "/api/sid/" + link.attr("host") + "/dump/install/" + dump + "/" + schemaName;
                console.log( "get" + requestUrl );
                $.get(requestUrl, function(json){
                	console.log("got");
                	console.log(json);
                    
                });
        	}
        	
        }
        
        function loadDumps() {
            $(".dumps").find(".loading").show();

            //clear existing schemas
            $(".dump").remove();
                
            //get schema info
            link = $("#dbList").children(".active").children("a");
            var requestUrl = "/api/sid/" + link.attr("host") + "/dump";
            console.log("get " + requestUrl);
            $.get(requestUrl, loadDumpsCB);
        }
        
        function loadDumpsCB(json) {
        	console.log("got");
        	console.log(json);
        	dbItem = $("#dbItem");
	        //fill schemas
	        table = dbItem.find("table.dumps").find("tbody");
	        for(i in json) {
	            $('#tmplDump').tmpl(json[i]).appendTo(table);   
            }
            $(".dumps").find(".loading").hide();
            table.find(".dumpRadio").first().attr("checked", "checked");
        }
        
        function dropSchema(button) {
          var b = $(button.target);
          var schema = b.parents("tr").children("td:first-child").text();
          var dbHost = $("#dbList").children(".active").children("a").attr("host");
          var requestUrl = "/api/sid/" + dbHost + "/drop/" + schema; 

          $("#confirmModalText").text("Drop schema " + schema + "?");
          $("#confirmModalYes").unbind();
          $("#confirmModalYes").click(function() {
        	  $("#confirmModal").modal('hide');
        	  console.log("yes!");
          });
          $("#confirmModal").modal('show');
          /*
          console.log("get " + requestUrl);
          $.get(requestUrl, dropSchemaCB);
          */
        }
        
        function dropSchemaCB(json) {
          console.log("got");
          console.log(json);
        }
        
        function hideShow(button) {
        	var b = $(button.target);
        	if( b.text() == '-') {
        		b.parent().children('.refresh').hide();
        	    b.parents(".row").next().hide();        		
        	    b.text('+');        		
        	}
        	else {
        	    b.parents(".row").next().show();
        		b.parent().children('.refresh').show();
        	    b.text('-');        		
        	}
        }
        
	</script>


    <div class="container">
		<div class="container-fluid">
			<div class="row" id="header">
				<div class="span-one-third">&nbsp</div>
				<div class="span-one-third" id="loadingDiv">
					&nbsp<span class="label notice" id="loadingLabel">Loading...</span>
				</div>
				<div class="span-one-third ">
					<button class="btn pull-right" id="reloadSidList">Refresh</button>
				</div>
			</div>
			<div class="sidebar">
				<div class="well">
					<select id="sids" style="width: 100%;">
						<option host="host.com" sid="test1">test1@test</option>
						<option host="host.com" sid="test2">test2@test</option>
					</select> <br /> <br />
					<h5>General</h5>
					<ul>
						<li><a href="#" id="menuTablespaces">Tablespaces</a></li>
						<li><a href="#" id="menuSchemas">Schemas</a></li>
						<li><a href="#" id="menuDumps">Dumps</a></li>
					</ul>
				</div>
			</div>
			<div class="content">
				<div class="well" id="schemeInfo">
				</div>
				<div class="well" id="tablespaces">
					<table>
						<thead>
							<tr>
								<th width="40%">Name</th>
								<th width="20%">Free</th>
								<th width="20%">Total</th>
								<th width="20%">Used</th>
							</tr>
						</thead>
						<tbody>
							<tr><td>SOME_SPACE</td><td>100GB</td><td>200GB</td><td>50%</td></tr>
							<tr><td>SOME_SPACE</td><td>100GB</td><td>200GB</td><td>50%</td></tr>
						</tbody>
					</table>
				</div>
				<div class="well" id="dumps">
					<table>
						<thead>
							<tr>
								<th width="5%">&nbsp</th>
								<th width="95%">Name</th>
							</tr>
						</thead>
						<tbody>
							<tr><td><input class="dumpRadio" type="radio" name ="dumps" value="${name}"/></td><td>prod_asr_dump_1259845239.dmp</td></tr>
						</tbody>
					</table>
				</div>
				<div class="well" id="schemas">
					<table>
						<thead>
							<tr>
								<th width="40%">Name</th>
								<th width="20%">Size</th>
								<th width="20%">Connections</th>
								<th width="20%">&nbsp</th>
							</tr>
						</thead>
						<tbody>
							<tr><td>ROMANCHUK</td><td>100GB</td><td>10</td><td></td></tr>
							<tr><td>ROMANCHUK</td><td>100GB</td><td>10</td><td></td></tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
    <!-- modal -->
    <div id="confirmModal" class="modal hide fade">
        <div class="modal-header">
            <a href="#" class="close">&times;</a>
            <h3>Confirm</h3>
        </div>
        <div class="modal-body">
            <p id="confirmModalText">Drop selected schema?</p>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn primary" id="confirmModalYes">Yes</a>
            <a href="#" class="btn secondary" id="confirmModalNo">No</a>
        </div>
    </div>

</body>
</html>


