<html>
<head>
<link rel="stylesheet" type="text/css" href="main.css" />
<link rel="stylesheet" href="http://twitter.github.com/bootstrap/1.3.0/bootstrap.min.css">
</head>
<body>

    <script src="jquery-1.6.2.js"></script>
    <script src="jquery.tmpl.js"></script>   
    <script id = "tmplDBItem" type="text/x-jquery-tmpl">      
        <form>
        <div class="row">
            <div class="span12 columns">
                <h3>Tablespaces</h3>    
            </div>
            <div class="span4 columns right">
                <a href="#" class="btn refresh">R</a>  
                <a href="#" class="btn hideShow" >-</a>
            </div>
        </div>
        <table class="tablespaces">
            <thead>
                <tr>
                    <th width="40%">Name</th>
                    <th width="20%">Free</th>
                    <th width="20%">Total</th> 
                    <th width="20%">Used</th> 
                </tr>
            </thead>
            <tbody>
            	<tr class="loading"><td colspan="4" class="center">Loading <img src="loading_icon.gif" /></td></tr>
            </tbody>
        </table>
        <br/>
        <div class="row">
            <div class="span12 columns">
                <h3>Dumps</h3>    
            </div>
            <div class="span4 columns right">
                <a href="#" class="btn refresh" id="dumpsRefresh">R</a>  
                <a href="#" class="btn hideShow">-</a>
            </div>
        </div>
        <table class="dumps">
            <thead>
                <tr>
                    <th width="5%">&nbsp</th>
                    <th width="95%">Name</th>
                </tr>
            </thead>
            <tbody>
            	<tr class="loading"><td colspan="4" class="center">Loading <img src="loading_icon.gif" /></td></tr>
            </tbody>
        </table>
        <div class="row">
            <div class="clearfix span16" >
                    <div class="clearfix" id="cDumpName">
                    <label for="schemaName">Scheme name</label>
                    <div class="input">
                        <input class="error" id="schemaName" name="schemaName" size="30" type="text">
                        <!--<span class="help-inline">scheme name to dump installation</span>-->
                        <a class="btn" id="dumpInstall">Install</a>
                    </div>
                    </div>
            </div>
        </div>

        <br/>
        <br/>
        <br/>
        <div class="row">
            <div class="span12 columns">
                <h3>Schemes</h3>    
            </div>
            <div class="span4 columns right">
                <a href="#" class="btn refresh">R</a>  
                <a href="#" class="btn hideShow">-</a>
            </div>
        </div>
        <table class="schemes">
            <thead>
                <tr>
                    <th width="40%">Name</th>
                    <th width="20%">Size</th>
                    <th width="20%">Connections</th> 
                    <th width="20%">&nbsp</th> 
                </tr>
            </thead>
            <tbody>
            	<tr class="loading"><td colspan="4" class="center">Loading <img src="loading_icon.gif" /></td></tr>
            </tbody>
        </table>
        </form>
    </script> 
    <script id = "tmplDBTabItem" type="text/x-jquery-tmpl">
        <li><a href="#" host="${host}/${sid}" class="dbLink">${sid}@${host}</a></li>
    </script> 
    <script id = "tmplSchema" type="text/x-jquery-tmpl">
                            <tr class="{{if connection_count > 0 && connection_count <= 3 }}schemaFree {{/if}}{{if connection_count > 3 }}schemaUsed {{/if}}dbSchema">
                            <td >${name}</td>
                            <td >${size}GB</td>
                            <td >${connection_count}</td>
                            <td class="right">{{if connection_count < 1 }}<a class="btn danger schemaDrop">Drop</a>{{/if}}</td>
                            </tr>
    </script> 
    <script id = "tmplTablespace" type="text/x-jquery-tmpl">
                            <tr class="tablespace">
                            <td >${name}</td>
                            <td >${freeSpace}GB</td>
                            <td >${totalSpace}GB</td>
                            <td >${percent}%</td>
                            </tr>
    </script> 
    <script id = "tmplDump" type="text/x-jquery-tmpl">
                            <tr class="dump">
                            <td ><input class="dumpRadio" type="radio" name ="dumps" value="${name}"/></td>
                            <td >${name}</td>
                            </tr>
    </script> 
    <script type="text/javascript">
        $(document).ready(function(){
           $('#reloadDBList').click(function(){
           	   console.log("get /api/database/list");
        	   $.get("/api/database/list", loadDatabaseListCB);
           });
           
           table = $("#db");
           loadDatabaseListCB([{sid:"SID", host : "mox00.se-b.ru"}, {sid:"SID2", host : "mox02.se-b.ru"}]);
           loadSchemasCB([{name:"scheme1", size:"50", connection_count:"123"}]);
           loadSchemasCB([{name:"scheme2", size:"40", connection_count:"0"}]);
           loadSchemasCB([{name:"scheme3", size:"20", connection_count:"1"}]);
           loadTablespacesCB([{name:"ASRDATA", freeSpace:103, totalSpace:154}]);
           loadDumpsCB([{name:"proasr-123871897239481289.dmp"}]);
           
           item = $('.tmplDBTabItem[host="mox00.se-b.ru/SID"]');
         });
        
        
        function loadDatabaseListCB(json) {
        	console.log("got");
        	console.log(json);
            list = $('#dbList');
            list.children().remove();
            for(i in json) {
                $('#tmplDBTabItem').tmpl(json[i]).appendTo(list);                 
            }
            $('.dbLink').click(clickDbTab);
			$('.dbLink').first().click();
			
			$('.hideShow').click(hideShow);
			$('#dumpInstall').click(dumpInstall);
        }
        
        function dumpInstall() {
        	var schemaName = $('#schemaName').val();
        	if( schemaName == null || schemaName == '' ) {
        		$('#cDumpName').addClass('error');
        	} else {
        		$('#cDumpName').removeClass('error');
        		var link = $("#dbList").children(".active").children("a");
        		var dump = $(".dumpRadio:checked").val();
                var requestUrl = "/api/database/info/" + link.attr("host") + "/dump/install/" + dump + "/" + schemaName;
                console.log( "get" + requestUrl );
                $.get(requestUrl, function(json){
                	console.log("got");
                	console.log(json);
                    
                });
        	}
        	
        }
        
        function clickDbTab(e) {
        	link = $(e.target);
        	if( !link.parent().hasClass("active") ) {
	        	link.parent().parent().children().removeClass("active");
	        	link.parent().addClass("active");
	   		     	
	        	$("#dbItem").empty();
	        	$('#tmplDBItem').tmpl().appendTo(dbItem);
	        	$("#dbSchemaRefresh").click(loadSchemas);
	        	
	        	loadSchemas();
	        	loadTablespaces();
	        	loadDumps();
        	}
        }
        
        function loadSchemas() {
        	$(".schemes").find(".loading").show();

			//clear existing schemas
			$(".dbSchema").remove();
        		
        	//get schema info
        	link = $("#dbList").children(".active").children("a");
        	var requestUrl = "/api/database/info/" + link.attr("host") + "/schema";
        	console.log("get " + requestUrl);
    	    $.get(requestUrl, loadSchemasCB);
        }
        
        function loadSchemasCB(json) {
        	console.log("got");
        	console.log(json);
        	dbItem = $("#dbItem");
	        //fill schemas
	        table = dbItem.find("table.schemes").find("tbody");
	        for(i in json) {
              $('#tmplSchema').tmpl(json[i]).appendTo(table);   
            }
            $(".schemaDrop").click(dropSchema)
            $(".schemes").find(".loading").hide();
        }
        
        function loadTablespaces() {
            $(".tablespaces").find(".loading").show();

            //clear existing schemas
            $(".tablespace").remove();
                
            //get schema info
            link = $("#dbList").children(".active").children("a");
            var requestUrl = "/api/database/info/" + link.attr("host") + "/tablespace";
            console.log("get " + requestUrl);
            $.get(requestUrl, loadTablespacesCB);
        }
        
        function loadTablespacesCB(json) {
        	console.log("got");
        	console.log(json);
        	dbItem = $("#dbItem");
	        //fill schemas
	        table = dbItem.find("table.tablespaces").find("tbody");
	        for(i in json) {
	          $('#tmplTablespace').tmpl(json[i]).appendTo(table);   
            }
            $(".tablespaces").find(".loading").hide();
            
        }
        
        function loadDumps() {
            $(".dumps").find(".loading").show();

            //clear existing schemas
            $(".dump").remove();
                
            //get schema info
            link = $("#dbList").children(".active").children("a");
            var requestUrl = "/api/database/info/" + link.attr("host") + "/dump";
            console.log("get " + requestUrl);
            $.get(requestUrl, loadDumpsCB);
        }
        
        function loadDumpsCB(json) {
        	console.log("got");
        	console.log(json);
        	dbItem = $("#dbItem");
	        //fill schemas
	        table = dbItem.find("table.dumps").find("tbody");
	        for(i in json) {
	            $('#tmplDump').tmpl(json[i]).appendTo(table);   
            }
            $(".dumps").find(".loading").hide();
            table.find(".dumpRadio").first().attr("checked", "checked");
        }
        
        function dropSchema(button) {
          var b = $(button.target);
          var schema = b.parents("tr").children("td:first-child").text();
          var dbHost = $("#dbList").children(".active").children("a").attr("host");
          var requestUrl = "/api/database/info/" + dbHost + "/drop/" + schema; 
          console.log("get " + requestUrl);
          $.get(requestUrl, dropSchemaCB);          
        }
        
        function dropSchemaCB(json) {
          console.log("got");
          console.log(json);
        }
        
        function hideShow(button) {
        	var b = $(button.target);
        	if( b.text() == '-') {
        		b.parent().children('.refresh').hide();
        	    b.parents(".row").next().hide();        		
        	    b.text('+');        		
        	}
        	else {
        	    b.parents(".row").next().show();
        		b.parent().children('.refresh').show();
        	    b.text('-');        		
        	}
        }
	</script>
<br/>
<br/>
<div class="container" id="db">
    <div class="container">
        <div class="row">
            <div class="span12 columns">
                <h1>Databases</h1>    
            </div>
            <div class="span4 columns right">
                <a href="#" id="reloadDBList" class="btn">R</a>
            </div>
        </div>    
        <ul class = "tabs" id="dbList">
        </ul>
        <div class="container" id="dbItem">
        </div>
    </div>
</div>
</body>
</html>